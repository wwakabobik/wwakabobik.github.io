<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>Test classes - how to rerun them</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
<link href="https://wwakabobik.github.io/2024/08/pytest_rerunclassfailures/" rel="canonical" />
  <!-- Feed -->
        <link href="https://wwakabobik.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="wwakabobik's lair Full Atom Feed" />
          <link href="https://wwakabobik.github.io/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="wwakabobik's lair Full RSS Feed" />
          <link href="https://wwakabobik.github.io/feeds/atom.xml" type="application/atom+xml" rel="alternate" title="wwakabobik's lair Atom Feed" />
          <link href="https://wwakabobik.github.io/feeds/rss.xml" type="application/rss+xml" rel="alternate" title="wwakabobik's lair RSS Feed" />
          <link href="https://wwakabobik.github.io/feeds/qa.atom.xml" type="application/atom+xml" rel="alternate" title="wwakabobik's lair Categories Atom Feed" />
          <link href="https://wwakabobik.github.io/feeds/qa.rss.xml" type="application/rss+xml" rel="alternate" title="wwakabobik's lair Categories RSS Feed" />

  <link href="https://wwakabobik.github.io/theme/css/style.css" type="text/css" rel="stylesheet" />


    <!-- Custom fonts -->
    <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->



    <meta name="description" content="Dealing with imperfect code and test environments can drive you crazy, especially when you need to properly rerun failed tests while...">

    <meta name="author" content="wwakabobik">

    <meta name="tags" content="qa">
    <meta name="tags" content="python">
    <meta name="tags" content="pytest">




<!-- Open Graph -->
<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="wwakabobik's lair"/>
<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Test classes - how to rerun them"/>
<meta prefix="og: http://ogp.me/ns#" property="og:description" content="Dealing with imperfect code and test environments can drive you crazy, especially when you need to properly rerun failed tests while..."/>
<meta prefix="og: http://ogp.me/ns#" property="og:locale" content="en_US"/>
<meta prefix="og: http://ogp.me/ns#" property="og:url" content="https://wwakabobik.github.io/2024/08/pytest_rerunclassfailures/"/>
<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article"/>
<meta prefix="og: http://ogp.me/ns#" property="article:published_time" content="2024-08-21 13:44:00+02:00"/>
<meta prefix="og: http://ogp.me/ns#" property="article:modified_time" content="2025-09-26 20:58:35.188725+02:00"/>
<meta prefix="og: http://ogp.me/ns#" property="article:author" content="https://wwakabobik.github.io/author/wwakabobik/">
  <meta prefix="og: http://ogp.me/ns#" property="article:publisher" content="https://www.facebook.com/wwakabobik" />
<meta prefix="og: http://ogp.me/ns#" property="article:section" content="qa"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="qa"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="python"/>
<meta prefix="og: http://ogp.me/ns#" property="article:tag" content="pytest"/>
<meta prefix="og: http://ogp.me/ns#" property="og:image" content="https://wwakabobik.github.io/assets/images/bg/qa.png">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Test classes - how to rerun them",
  "headline": "Test classes - how to rerun them",
  "datePublished": "2024-08-21 13:44:00+02:00",
  "dateModified": "2025-09-26 20:58:35.188725+02:00",
  "author": {
    "@type": "Person",
    "name": "wwakabobik",
    "url": "https://wwakabobik.github.io/author/wwakabobik/"
  },
  "image": "https://wwakabobik.github.io/assets/images/bg/qa.png",
  "url": "https://wwakabobik.github.io/2024/08/pytest_rerunclassfailures/",
  "description": "Dealing with imperfect code and test environments can drive you crazy, especially when you need to properly rerun failed tests while..."
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>
          <li><a href="/" role="presentation">Home</a></li>
          <li><a href="/tag/index.html" role="presentation">Tags</a></li>
          <li><a href="/category/index.html" role="presentation">Categories</a></li>
          <li><a href="/archive/index.html" role="presentation">Archives</a></li>

              <li role="presentation"><a href="https://wwakabobik.github.io/pages/about/">About</a></li>

    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="https://wwakabobik.github.io/" aria-label="Home" title="Home">
                  <i class="ic ic-arrow-left" aria-hidden="true"></i>
                  <span>Home</span>
                </a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button" aria-label="Menu">
              <i class="ic ic-menu" aria-hidden="true"></i>
              <span>Menu</span>
            </a>
          </span>
        </nav>
        <h1 class="post-title">Test classes - how to rerun them</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="https://wwakabobik.github.io/author/wwakabobik/">Iliya Vereshchagin</a>
            | <time datetime="21 Aug 2024">21 Aug 2024</time>
        </span>
            <div class="post-cover cover" style="background-image: url('https://wwakabobik.github.io/assets/images/bg/qa.png')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>Hard times call for hard measures. Not every application's architecture and testing environment are ideal. They can be downright bad and inflexible. And to test them, you have to step over a tester's pride and violate the basic principles of software testing.</p>
<div class="section" id="the-problem-that-doesn-t-exist">
<h2>The problem that doesn't exist</h2>
<p>Let's get a crash course on best testing practices.</p>
<p>Firstly, every self-respecting tester should know what a &quot;software testing pyramid&quot; is. Specifically, the number of simple tests, starting from unit tests, should be significantly larger than the subsequent API, then UI, and E2E tests.</p>
<img alt="Testing pyramid" src="/assets/images/articles/qa/pytest_rerunclassfailures/pyramid-test-pyramid.jpg" />
<p>This is because the cost of developing, executing, and maintaining such tests is lower, they run faster, and usually catch most errors at the earliest stages of development and testing. Meanwhile, the longest tests, which sequentially cover a long sequence of actions and states following business logic - E2E tests usually make up the smallest part of testing. Primarily because all their components have already been (often repeatedly) checked by smaller and simpler tests. Secondly, the truly critical business logic, which E2E tests should be, is usually just a couple of scenarios, which, I believe, with a high degree of probability will make up your smoke set for pre-release testing.</p>
</div>
<div class="section" id="the-problem-that-exists">
<h2>The problem that exists</h2>
<p>Well, our world is not perfect. Companies and teams are not perfect, code is not perfect, and honestly, people are not perfect, I would even say, they are a rare kind of crap. And we have to live and work with this.</p>
<p>Suppose you have a test environment with a hundred tests that run in an isolated environment - behind several firewalls (like the one we run tests on, the one where the system is deployed, and the one that launches the tests - our CI server), due to which there is a call to one of the cloud testing platforms. If you have worked with such systems, then you probably know that deploying a virtual machine takes some time, so it doesn't make much sense to break the connection and recreate it for each test. Moreover, even if you use only a few deployed virtual machines, their performance leaves much to be desired. Well, due to the accumulation of internal networks, as well as different regions, this bundle, so to speak, starts to work far from the speed of light.</p>
<img alt="Running test on Browserstack on VMs with video over firewall is pain" src="/assets/images/articles/qa/pytest_rerunclassfailures/browserstack.jpg" />
<p>Well, running tests becomes slower, but still, no one prevents us from resetting and setting the state for each test inside such a virtual machine. Yes, but... the system is written in such a way that it lacks test handles that can be pulled to set the desired state. Moreover, for UI tests, you can't just go to the desired URL to the desired form, you have to click through several screens. All this takes time, and in the conditions of a test environment, preparing for one test can take 1-2 minutes. This already sounds like a huge problem, especially if we are trying to write tests well, atomically, and the next check is, say, entering a character in a field. A disaster that forces us to either throw out such tests or wait for results for hours.</p>
<p>Here, it seems, it's time to step over our tester's pride and lump several checks into one test. Let's say, now the test will fill in twenty fields and click a button to go to another screen. I think you understand that during input into a field, flipping a checkbox or flipper, something can go wrong - an error can be displayed, for example, text can be lost, and when interacting with another component, the state can change again, and we will surely get not quite a valid result. So, it means we still have to break our check into tests, but at the same time leaving the system state for each of the tests, equal to the previous state. So, we can do this if we reset the context within the session. This is of course good, but then we will raise a virtual machine for a session that combines a sequence of tests every time. Trying to restore atomicity, we will lose performance. Then there is another alternative - to isolate the state by files, and even better - by wrapping tests in test classes. Yes, I forgot to say that I write in python and use pytest, so let's talk about it.</p>
</div>
<div class="section" id="the-problem-we-created">
<h2>The problem we created</h2>
<p>So, a good and beautiful atomic test, with which you usually work, looks like this:</p>
<div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;This module has no class, only test functions&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">test_no_class_first</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test always passes&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">test_no_class_second</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test always fails&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="kc">False</span>
</pre></div>
<p>However, for my particular case, we decided to use test classes. They will look something like this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestBasic</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This is a basic test&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">test_basic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is basic test 1&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">test_basic2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is basic test 2&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">test_basic3</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is basic test 3&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">True</span>
</pre></div>
<p>Personally, it makes my eyes bleed because I can imagine the problems it will cause me. Although it looks good at first glance. But that's at first glance. If you call the tests as usual:</p>
<div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests
</pre></div>
<p>Then the tests will be executed sequentially, and if there was some interdependence in them, it will be preserved.</p>
<p>However, if you try to call the tests in multiple threads (with pytest-xdist), the sequence will be shuffled.</p>
<div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests<span class="w"> </span>-n<span class="o">=</span>auto
</pre></div>
<p>To avoid this, you need to specify how exactly to group the tests. For this, don't forget to specify the grouping method.</p>
<div class="highlight"><pre><span></span>pytest<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-n<span class="o">=</span>auto<span class="w"> </span>--dist<span class="w"> </span>loadscope
</pre></div>
<p>Now, suppose we have twenty steps, dependent on each other, and we have to go through all of them, even if one of the first tests failed. But there is no point in this anymore, as the state has already been violated. Therefore, we need to somehow implement the &quot;fail fast&quot; logic in this case. For this, we will have to interfere a little with the logic of <cite>pytest</cite> and implement:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">pytest_runtest_makereport</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">call</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;incremental&quot;</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">call</span><span class="o">.</span><span class="n">excinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">parent</span><span class="o">.</span><span class="n">_previousfailed</span> <span class="o">=</span> <span class="n">item</span>


<span class="k">def</span> <span class="nf">pytest_runtest_setup</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">previousfailed</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;_previousfailed&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">previousfailed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">pytest</span><span class="o">.</span><span class="n">xfail</span><span class="p">(</span><span class="s2">&quot;previous test failed (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">previousfailed</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
<p>Now those test classes that need to be failed quickly need to be marked in advance:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">incremental</span>
<span class="k">class</span> <span class="nc">TestMarkedFailFast</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This test class will fail fast&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">test_will_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This test will pass&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">test_will_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This test will fail&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">test_wont_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This test won’t run&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">True</span>
</pre></div>
<p>Another problem we created is the pointlessness of using the <cite>pytest-rerunfailures</cite> plugin. If we decide to use it, the test will be restarted outside the class context with a completely different state than we expected. You can break a bunch of copies on the topic of whether reruns are worth using or not. In the end, we will survive a couple of falls and manually restart before the release. If there are many falls, perhaps something critical has broken, and we will quickly identify the error, and we will have to restart most of the tests anyway. But if you have a lot of tests - thousands, and instability still happens, and time is a pity, if the test, of course, does not regularly unstably fall, then delegate the restart to the machine. But in our case... there are no such options, it turns out?</p>
</div>
<div class="section" id="the-problem-i-solved">
<h2>The problem I solved</h2>
<p>So, to solve this problem, I wrote the <cite>pytest-rerunclassfailures</cite> plugin.</p>
<p>To install it and start using it, just install it via pip:</p>
<div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>pytest-rerunclassfailures
</pre></div>
<p>To run tests with reruns, just pass the --rerun-class-max parameter with some number of reruns.</p>
<div class="highlight"><pre><span></span>pytest<span class="w"> </span>tests<span class="w"> </span>--rerun-class-max<span class="o">=</span><span class="m">2</span>
</pre></div>
<p>Or add it explicitly in <cite>pytest.ini</cite>:</p>
<div class="highlight"><pre><span></span><span class="k">[pytest]</span>
<span class="na">plugins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">pytest-rerunclassfailures</span>
<span class="na">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">--rerun-class-max=3</span>
</pre></div>
<p>Results of run will look like:</p>
<img alt="Output of test run with pytest-rerunclassfailures plugin" src="/assets/images/articles/qa/pytest_rerunclassfailures/pytest-rerunclassfailures.jpg" />
<p>You can also set additional parameters, like delay between reruns or logging type:</p>
<ul class="simple">
<li><cite>--rerun-class-max</cite> - the number of retries for a failed test class. Default is 0.</li>
<li><cite>--rerun-delay</cite> - delay between retries in seconds. Default is 0.5 seconds.</li>
<li><cite>--rerun-show-only-last</cite> - show results of only the last retry - there will be no &quot;rerun&quot; in the log, only the last, final run with the final result. Not specified by default.</li>
<li><cite>--hide-rerun-details</cite> - remove rerun details (errors and traceback) in the terminal. Not specified by default.</li>
</ul>
<div class="highlight"><pre><span></span><span class="nv">PYTHONPATH</span><span class="o">=</span>.<span class="w"> </span>pytest<span class="w"> </span>-s<span class="w"> </span>tests<span class="w"> </span>-p<span class="w"> </span>pytest_rerunclassfailures<span class="w"> </span>--rerun-class-max<span class="o">=</span><span class="m">3</span><span class="w"> </span>--rerun-delay<span class="o">=</span><span class="m">1</span><span class="w"> </span>--rerun-show-only-last
</pre></div>
<p>The plugin is compatible with <cite>pytest-xdist</cite>, you can use it in multiple threads, but always specify <cite>--dist loadscope</cite>. After an error, the class will be reset to its initial state, however, the next test will fail on restart, as the class state was changed bypassing the constructor inside the function level fixture. However, I hope you don't use this bad practice in your code.</p>
<div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Test class with function (fixtures) attributes&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">choice</span>

<span class="kn">import</span> <span class="nn">pytest</span>


<span class="n">random_attribute_value</span> <span class="o">=</span> <span class="n">choice</span><span class="p">((</span><span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">function_fixture</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture to set function attribute&quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="s2">&quot;initial&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;initial&quot;</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">function_fixture_secondary</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fixture to set function attribute&quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="s2">&quot;secondary&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;secondary&quot;</span>


<span class="k">class</span> <span class="nc">TestFunctionFixturesAttributes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test class with function params attributes&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">test_function_fixtures_attribute_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_fixture</span><span class="p">):</span>  <span class="c1"># pylint: disable=W0621</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test function fixture attribute at the beginning of the class&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="s2">&quot;initial&quot;</span>
        <span class="k">assert</span> <span class="n">function_fixture</span> <span class="o">==</span> <span class="s2">&quot;initial&quot;</span>

    <span class="k">def</span> <span class="nf">test_function_fixtures_attribute_recheck</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_fixture_secondary</span><span class="p">):</span>  <span class="c1"># pylint: disable=W0621</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test function fixture attribute after changing attribute value&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="s2">&quot;secondary&quot;</span>  <span class="c1"># type: ignore  # pylint: disable=E0203</span>
        <span class="k">assert</span> <span class="n">function_fixture_secondary</span> <span class="o">==</span> <span class="s2">&quot;secondary&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">=</span> <span class="n">random_attribute_value</span>  <span class="c1"># type: ignore  # pylint: disable=attribute-defined-outside-init</span>
        <span class="c1"># attribute is changed, but fixture is not</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">attribute</span> <span class="o">==</span> <span class="n">random_attribute_value</span>
        <span class="k">assert</span> <span class="n">function_fixture_secondary</span> <span class="o">==</span> <span class="s2">&quot;secondary&quot;</span>

    <span class="k">def</span> <span class="nf">test_function_fixtures_attribute_forced_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test function fixture attribute to be forced failure&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="kc">False</span>
</pre></div>
</div>
<div class="section" id="a-bit-of-technical-details">
<h2>A bit of technical details</h2>
<p>To be able to intercept and restart test class tests, I interfere with pytest_runtest_protocol and take control if it's a test class:</p>
<div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">hookimpl</span><span class="p">(</span><span class="n">tryfirst</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pytest_runtest_protocol</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span><span class="p">,</span> <span class="n">nextitem</span><span class="p">:</span> <span class="n">_pytest</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">Item</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</pre></div>
<p>Next, we get the test class, and find its descendants - test functions:</p>
<div class="highlight"><pre><span></span><span class="n">parent_class</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getparent</span><span class="p">(</span><span class="n">pytest</span><span class="o">.</span><span class="n">Class</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">items</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]:</span>
    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">cls</span> <span class="o">==</span> <span class="n">i</span><span class="o">.</span><span class="n">cls</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="n">siblings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>
<p>And then we execute the standard testing protocol for each descendant sequentially:</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">siblings</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
    <span class="c1"># Before run, we need to ensure that finalizers are not called (indicated by None in the stack)</span>
    <span class="n">nextitem</span> <span class="o">=</span> <span class="n">siblings</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">siblings</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">siblings</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">siblings</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reports</span> <span class="o">=</span> <span class="n">runtestprotocol</span><span class="p">(</span><span class="n">siblings</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">nextitem</span><span class="o">=</span><span class="n">nextitem</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
<p>And, finally, after determining the test status (how many times we had to restart it and set the result or rerun), we send the results back:</p>
<div class="highlight"><pre><span></span><span class="n">item</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_runtest_logstart</span><span class="p">(</span><span class="n">nodeid</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">rerun</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">test_class</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">]):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reporting node results </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_class</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">]),</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">report</span> <span class="ow">in</span> <span class="n">rerun</span><span class="p">:</span>
        <span class="n">item</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_runtest_logreport</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="n">report</span><span class="p">)</span>
<span class="n">item</span><span class="o">.</span><span class="n">ihook</span><span class="o">.</span><span class="n">pytest_runtest_logfinish</span><span class="p">(</span><span class="n">nodeid</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">nodeid</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
</pre></div>
<p>If you need to restart the test class, you must definitely do a teardown and recreate the test class in its original form.</p>
<div class="highlight"><pre><span></span><span class="c1"># Drop failed fixtures and cache</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_remove_cached_results_from_failed_fixtures</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
<span class="c1"># Clean class setup state stack</span>
<span class="n">item</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">_setupstate</span><span class="o">.</span><span class="n">stack</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="bp">self</span><span class="o">.</span><span class="n">_teardown_test_class</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>  <span class="c1"># Teardown the class and emulate recreation of it</span>
<span class="c1"># We can&#39;t replace the class because session-scoped fixtures will be lost</span>
<span class="n">parent_class</span><span class="p">,</span> <span class="n">siblings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recreate_test_class</span><span class="p">(</span><span class="n">parent_class</span><span class="p">,</span> <span class="n">siblings</span><span class="p">,</span> <span class="n">initial_state</span><span class="p">)</span>
<span class="n">item</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent_class</span>  <span class="c1"># ensure that we&#39;re using updated class</span>
</pre></div>
<p>That's all. I hope my plugin will help you a little when you are dealing with bad architectural decisions, bad code, and tests.</p>
</div>
<div class="section" id="conclusions">
<h2>Conclusions</h2>
<p>That's all. I hope my plugin will help you a little when you are dealing with bad architectural decisions, bad code, and tests. If you like my article, feel free to <a class="reference external" href="https://www.donationalerts.com/r/rocketsciencegeek">share a coin</a>. And, for sure here are links to the <a class="reference external" href="https://github.com/wwakabobik/pytest-rerunclassfailures">GitHub repo</a> and <a class="reference external" href="https://pypi.org/project/pytest-rerunclassfailures/">pypi package</a>.</p>
</div>

            </section>

            <section class="post-info">
                <div class="post-share">
                    <a title="Twitter" aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Test classes - how to rerun them&amp;url=https://wwakabobik.github.io/2024/08/pytest_rerunclassfailures/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                      <i class="ic ic-twitter" aria-hidden="true"></i><span class="hidden">Twitter</span>
                    </a>
                    <a title="Facebook" aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://wwakabobik.github.io/2024/08/pytest_rerunclassfailures/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                      <i class="ic ic-facebook" aria-hidden="true"></i><span class="hidden">Facebook</span>
                    </a>
                    <a title="LinkedIn" aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://wwakabobik.github.io/2024/08/pytest_rerunclassfailures/&amp;title=Test classes - how to rerun them" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;">
                      <i class="ic ic-linkedin" aria-hidden="true"></i><span class="hidden">LinkedIn</span>
                    </a>
                    <a title="Email" aria-label="Email" class="email" href="mailto:?subject=Test classes - how to rerun them&amp;body=https://wwakabobik.github.io/2024/08/pytest_rerunclassfailures/">
                      <i class="ic ic-mail" aria-hidden="true"></i><span class="hidden">Email</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="https://wwakabobik.github.io/tag/qa/">qa</a><a href="https://wwakabobik.github.io/tag/python/">python</a><a href="https://wwakabobik.github.io/tag/pytest/">pytest</a>                </aside>

                <div class="clear"></div>

                <aside class="post-author">


                        <figure class="post-author-avatar">
                            <img src="https://wwakabobik.github.io/assets/images/authors/wwakabobik.png" alt="Iliya Vereshchagin" />
                        </figure>
                    <div class="post-author-bio">
                        <h4 class="post-author-name"><a href="https://wwakabobik.github.io/author/wwakabobik/">Iliya Vereshchagin</a></h4>
                            <p class="post-author-about">Quality is not an act, it's habit</p>
                            <span class="post-author-location"><i class="ic ic-location"></i> Serbia, Novi Sad</span>
                        <!-- Social linkes in alphabet order. -->
                            <span class="post-author-github"><a target="_blank" href="https://github.com/wwakabobik"><i class="ic ic-github"></i> GitHub</a></span>
                        <span class="post-author-instagram"><a target="_blank" href="https://www.instagram.com/i_ver"><i class="ic ic-instagram"></i> Instagram</a></span>
                        <span class="post-author-pypi"><a target="_blank" href="https://pypi.org/user/wwakabobik/"><i class="ic ic-pypi"></i> pypi</a></span>
                            <span class="post-author-linkedin"><a target="_blank" href="https://www.linkedin.com/in/wwakabobik"><i class="ic ic-linkedin"></i> LinkedIn</a></span>
                    </div>
                    <div class="clear"></div>
                </aside>

                </section>


                <aside class="post-nav">
                    <a class="post-nav-next" href="https://wwakabobik.github.io/2024/11/adding_tests_to_vercel/">
                        <section class="post-nav-teaser">
                            <i class="ic ic-arrow-left"></i>
                                <h2 class="post-nav-title">Adding Tests to Vercel</h2>
                            <p class="post-nav-excerpt">Adding automated tests to your Vercel project can be quick and efficient. Here's a...</p>
                        </section>
                    </a>
                    <a class="post-nav-prev" href="https://wwakabobik.github.io/2024/05/gaming_retro_renaissance/">
                        <section class="post-nav-teaser">
                            <i class="ic ic-arrow-right"></i>
                                <h2 class="post-nav-title">The Resurgence of Retro Games: A Pixelated Renaissance or a Soul-Crushing Cash Grab?</h2>
                            <p class="post-nav-excerpt">Some argue that remasters are a necessary evil, allowing classic games to be enjoyed...</p>
                        </section>
                    </a>
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">
        </section>
      </div>
    </footer>
  </section>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  <script type="text/javascript" src="https://wwakabobik.github.io/theme/js/script.js"></script>

    <!-- Global Site Tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MVTS1WKZ1T"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MVTS1WKZ1T', { 'anonymize_ip': true });
    </script>
</body>
</html>